# Payment Checker

Автоматическая проверка наличия платёжной интеграции на партнёрских сайтах.
Для каждого сайта тест авторизуется, проходит до платёжной формы, проверяет наличие провайдера
и сохраняет адрес крипто-кошелька в отчёт.

## Стек

- Python 3.10+
- Playwright (только Chromium)
- pytest
- Allure

---

## Установка с нуля на Windows

### 1. Установить Python

Скачать с https://python.org и установить.
При установке отметить галку **Add Python to PATH**.

Проверить:

```bash
python --version
```

### 2. Клонировать репозиторий

```bash
git clone https://github.com/твой_юзер/payment_checker.git
cd payment_checker
```

### 3. Создать виртуальное окружение

```bash
python -m venv .venv
.venv\Scripts\activate
```

### 4. Установить зависимости

```bash
pip install -r requirements.txt
```

### 5. Установить Chromium

```bash
playwright install chromium
```

### 6. Создать `.env` файл

```bash
copy .env.example .env
```

Открыть `.env` и заполнить:

```
LOGIN=твой_логин
PASSWORD=твой_пароль
HEADLESS=false
SLOW_MO=0
```

`HEADLESS=false` — браузер открывается с окном, удобно для наблюдения.
`SLOW_MO=0` — без задержек. Поставь 500-1000 если хочешь видеть каждый шаг.

### 7. Установить Allure

```bash
# Установить Scoop если ещё нет
irm get.scoop.sh | iex

# Установить Allure
scoop install allure
```

---

## Запуск тестов

```bash
# Все тесты
pytest --alluredir=reports/allure -v

# Один конкретный тест
pytest tests/test_site_365sms.py --alluredir=reports/allure -v

# Открыть отчёт после прогона
allure serve reports/allure
```

В отчёте для каждого теста:

- Пошаговый лог с результатом каждого действия
- Адрес крипто-кошелька в аттачменте
- При падении — видео и трейс Playwright для разбора причины

---

## Как читать отчёт при падении

Когда тест упал, Allure сохраняет два артефакта — видео и трейс.

### Видео

Открой упавший тест в отчёте → вкладка **Attachments** → файл `video`.
Видно что происходило на экране весь тест — где завис, что не кликнулось, когда страница не загрузилась.

### Трейс Playwright

Трейс — это полная запись теста: каждое действие, снапшот DOM до и после, сетевые запросы, консоль браузера.

1. Открой упавший тест в отчёте → вкладка **Attachments** → скачай `trace.zip`
2. Открой https://trace.playwright.dev/
3. Перетащи скачанный `trace.zip` в окно браузера

В трейсвьюере:

- Слева — таймлайн действий
- По клику на действие — снапшот страницы в этот момент
- Вкладка **Network** — все запросы и ответы
- Вкладка **Console** — ошибки JS

Трейс показывает точный момент падения и состояние страницы — быстрее любого дебага.

---

## Как добавить новый сайт

Добавление нового сайта делается через **Codex** — ИИ-агент пишет код и создаёт Pull Request в репозиторий. Твоя
задача — подготовить для него всю нужную информацию, а после принять PR и обновить локальный код.

### Шаг 1. Подготовить аккаунт

Зарегистрируй аккаунт на сайте вручную. Используй те же LOGIN и PASSWORD что в `.env` файле.

### Шаг 2. Пройти путь руками

Войди в аккаунт и пройди весь путь до адреса крипто-кошелька:

1. Открой DevTools (F12) → вкладка Network
2. Авторизуйся
3. Перейди в раздел пополнения / депозита
4. Выбери криптовалюту (обычно USDT TRC-20)
5. Введи любую сумму и подтверди
6. Дойди до экрана с адресом кошелька

По ходу пути собери:

- URL каждой страницы на которую переходишь
- XPath или CSS селекторы всех элементов с которыми взаимодействуешь (кнопки, поля, дропдауны)
- Если видишь API запрос к процессингу в Network — запомни путь (например `/api/deposit/get_providers`)
- Любые нюансы: модальные окна, iframe, редиректы на внешний домен

### Шаг 3. Написать промт для Codex

Открой Codex, подключи репозиторий и напиши задачу. Пример промта:

---

> Добавь новый сайт **example-casino.com** в проект payment_checker.
>
> **Авторизация:**
> Стартовая страница: `https://example-casino.com/`
> Кнопка открытия формы входа: `//button[@aria-label='login']`
> Поле логина: `//input[@name='email']`
> Поле пароля: `//input[@name='password']`
> Кнопка входа: `//button[@data-test='submit']`
> После логина в шапке появляется кнопка кошелька.
>
> **Путь до платёжной формы:**
> Кнопка кошелька в шапке: `//button[@aria-label='wallet']`
> В момент клика на кнопку уходит запрос `/api/payments/methods` — в ответе JSON список провайдеров,
> нужный провайдер называется `CryptoProvider` в поле `name`.
>
> **Платёжная форма:**
> Форма рендерится в iframe `//iframe[@id='crypto-frame']`
> Дропдаун выбора валюты: `//div[@class='currency-select']`
> Опция USDT TRC-20: `//li[text()='USDT TRC20']`
> Поле суммы: `//input[@id='amount']`
> Кнопка подтверждения: `//button[@type='submit']`
> Адрес кошелька после подтверждения: `//span[@class='wallet-address']` — текст элемента
>
> Смотри AGENTS.md для понимания архитектуры и паттернов.

---

Адаптируй под конкретный сайт. Чем точнее опишешь — тем меньше правок понадобится.

### Шаг 4. Принять Pull Request

Codex создаст PR с новыми файлами. Проверь что появились:

- `pages/site_название/` с нужными файлами
- `tests/test_site_название.py`

Если всё выглядит правильно — принимай PR на GitHub.

### Шаг 5. Обновить локальный код

После принятия PR подтяни изменения к себе:

```bash
git pull origin main
```

Запусти новый тест чтобы проверить что всё работает:

```bash
pytest tests/test_site_название.py --alluredir=reports/allure -v
allure serve reports/allure
```

---

## Структура проекта

```
payment_checker/
├── .env                            # креды (не коммитить!)
├── .env.example                    # шаблон для .env
├── .gitignore
├── README.md
├── AGENTS.md                       # инструкция для Codex
├── requirements.txt                # зависимости с зафиксированными версиями
├── pytest.ini                      # настройки pytest
├── conftest.py                     # фикстуры: браузер, страница, креды, allure хуки
├── config/
│   ├── __init__.py
│   └── settings.py                 # загрузка настроек из .env
├── pages/
│   ├── __init__.py
│   ├── base_page.py                # базовый класс с общими методами
│   ├── site_365sms/
│   │   ├── __init__.py
│   │   ├── login_page.py           # авторизация
│   │   ├── home_page.py            # навигация к платёжной форме
│   │   └── payment_page.py         # проверка логотипа + адрес кошелька
│   └── site_starzspins/
│       ├── __init__.py
│       ├── login_page.py           # авторизация
│       ├── home_page.py            # открытие кошелька + перехват API
│       └── payment_page.py         # проверка провайдера через API + адрес кошелька
└── tests/
    ├── __init__.py
    ├── base_test.py                # базовый класс тестов
    ├── test_site_365sms.py         # тест для 365sms.com
    └── test_site_starzspins.py     # тест для starzspins.com
```