# Payment Checker

Автоматическая проверка наличия платёжной интеграции на партнёрских сайтах.
Для каждого сайта тест авторизуется, проходит до платёжной формы, проверяет наличие провайдера
и сохраняет адрес крипто-кошелька в отчёт.

## Стек

- Python 3.10+
- Playwright (только Chromium)
- pytest
- Allure

---

## Установка с нуля на Windows

### 1. Установить Python

Скачать с https://python.org и установить.
При установке отметить галку **Add Python to PATH**.

Проверить:

```bash
python --version
```

### 2. Клонировать репозиторий

```bash
git clone https://github.com/твой_юзер/payment_checker.git
cd payment_checker
```

### 3. Создать виртуальное окружение

```bash
python -m venv .venv
.venv\Scripts\activate
```

### 4. Установить зависимости

```bash
pip install -r requirements.txt
```

### 5. Установить Chromium

```bash
playwright install chromium
```

### 6. Создать `.env` файл

```bash
copy .env.example .env
```

Открыть `.env` и заполнить:

```
LOGIN=твой_логин
PASSWORD=твой_пароль
HEADLESS=false
SLOW_MO=0
KNOWN_WALLETS=адрес1,адрес2
```

`HEADLESS=false` — браузер открывается с окном, удобно для наблюдения.
`SLOW_MO=0` — без задержек. Поставь 500-1000 если хочешь видеть каждый шаг.
`KNOWN_WALLETS` — список известных адресов кошельков через запятую, используется в паттерне 3.

### 7. Установить Allure

```bash
# Установить Scoop если ещё нет
irm get.scoop.sh | iex

# Установить Allure
scoop install allure
```

---

## Запуск тестов

```bash
# Все тесты
pytest --alluredir=reports/allure -v

# Один конкретный тест
pytest tests/test_site_365sms.py --alluredir=reports/allure -v

# Открыть отчёт после прогона
allure serve reports/allure
```

В отчёте для каждого теста:

- Пошаговый лог с результатом каждого действия
- Адрес крипто-кошелька в аттачменте
- При падении — видео и трейс Playwright для разбора причины

---

## Как читать отчёт при падении

Когда тест упал, Allure сохраняет два артефакта — видео и трейс.

### Видео

Открой упавший тест в отчёте → вкладка **Attachments** → файл `video`.
Видно что происходило на экране весь тест — где завис, что не кликнулось, когда страница не загрузилась.

### Трейс Playwright

Трейс — это полная запись теста: каждое действие, снапшот DOM до и после, сетевые запросы, консоль браузера.

1. Открой упавший тест в отчёте → вкладка **Attachments** → скачай `trace.zip`
2. Открой https://trace.playwright.dev/
3. Перетащи скачанный `trace.zip` в окно браузера

В трейсвьюере:

- Слева — таймлайн действий
- По клику на действие — снапшот страницы в этот момент
- Вкладка **Network** — все запросы и ответы
- Вкладка **Console** — ошибки JS

Трейс показывает точный момент падения и состояние страницы — быстрее любого дебага.

---

## Как добавить новый сайт

Добавление нового сайта делается через **Codex** — ИИ-агент пишет код в отдельной ветке и создаёт Pull Request. Ты
проверяешь локально, при необходимости просишь Codex починить, и только потом мержишь в `main`.

### Шаг 1. Определить паттерн проверки

В проекте три паттерна — выбери подходящий до написания промта:

**Паттерн 1 — по логотипу.** Тест доходит до платёжной формы и проверяет наличие логотипа провайдера на странице.
Используй если провайдер визуально присутствует на странице оплаты.

**Паттерн 2 — по API.** Тест перехватывает API ответ в момент открытия платёжной формы и ищет провайдера в JSON.
Используй если в DevTools видишь запрос к процессингу с JSON списком провайдеров.

**Паттерн 3 — по адресу кошелька.** Тест доходит до адреса кошелька и сверяет его со списком известных адресов из
`.env`.
Используй если определить провайдера невозможно, но кошелёк нужно проверить.

### Шаг 2. Подготовить аккаунт

Зарегистрируй аккаунт на сайте вручную. Используй те же LOGIN и PASSWORD что в `.env` файле.

### Шаг 3. Пройти путь руками

Войди в аккаунт и пройди весь путь до адреса крипто-кошелька:

1. Открой DevTools (F12) → вкладка Network
2. Авторизуйся
3. Перейди в раздел пополнения / депозита
4. Выбери криптовалюту (обычно USDT TRC-20)
5. Дойди до экрана с адресом кошелька

По ходу пути собери:

- URL стартовой страницы
- XPath или CSS селекторы всех элементов с которыми взаимодействуешь (кнопки, поля, дропдауны)
- Паттерн 2: путь API запроса в Network в момент открытия платёжной формы и структуру JSON ответа
- Паттерн 3: сам адрес кошелька — добавь его в `KNOWN_WALLETS` в `.env`
- Любые нюансы: модальные окна, iframe, редиректы

### Шаг 4. Написать промт для Codex

Открой Codex, подключи репозиторий и напиши задачу. Примеры промтов для каждого паттерна:

---

**Паттерн 1 — по логотипу:**

> Добавь новый сайт **example-casino.com** в проект payment_checker.
> Создай ветку `site/example-casino` и открой PR в `main`.
> Используй паттерн 1 — проверка по логотипу провайдера.
>
> **Авторизация:**
> Стартовая страница: `https://example-casino.com/`
> Кнопка входа: `//button[@aria-label='login']`
> Поле логина: `//input[@name='email']`
> Поле пароля: `//input[@name='password']`
> Кнопка подтверждения: `//button[@data-test='submit']`
>
> **Путь до платёжной формы:**
> Кнопка депозита: `//a[text()='Deposit']`
> Кнопка выбора Crypto: `//button[text()='Crypto']`
> Кнопка USDT TRC-20: `//button[text()='USDT TRC20']`
> Кнопка суммы 100: `//button[text()='100']`
> После клика редирект на форму провайдера.
>
> **Проверка и кошелёк:**
> Логотип провайдера на форме: `//a[@href='https://provider.com']`
> Адрес кошелька: `//div[@class='wallet']/p` — атрибут `title`
>
> Смотри AGENTS.md для понимания архитектуры и паттернов.

---

**Паттерн 2 — по API:**

> Добавь новый сайт **example-casino.com** в проект payment_checker.
> Создай ветку `site/example-casino` и открой PR в `main`.
> Используй паттерн 2 — проверка по API ответу.
>
> **Авторизация:**
> Стартовая страница: `https://example-casino.com/`
> Кнопка входа: `//button[@aria-label='login']`
> Поле логина: `//input[@name='email']`
> Поле пароля: `//input[@name='password']`
> Кнопка подтверждения: `//button[@data-test='submit']`
>
> **Путь до платёжной формы:**
> Кнопка кошелька в шапке: `//button[@aria-label='wallet']`
> В момент клика уходит запрос `/api/payments/methods` — в ответе JSON список провайдеров,
> нужный провайдер называется `CryptoProvider` в поле `name`.
> Форма рендерится в iframe `//iframe[@id='crypto-frame']`
> Дропдаун валюты: `//div[@class='currency-select']`
> Опция USDT TRC-20: `//li[text()='USDT TRC20']`
> Поле суммы: `//input[@id='amount']`
> Кнопка подтверждения: `//button[@type='submit']`
> Адрес кошелька: `//span[@class='wallet-address']` — текст элемента
>
> Смотри AGENTS.md для понимания архитектуры и паттернов.

---

**Паттерн 3 — по адресу кошелька:**

> Добавь новый сайт **example-casino.com** в проект payment_checker.
> Создай ветку `site/example-casino` и открой PR в `main`.
> Используй паттерн 3 — проверка по адресу кошелька через KNOWN_WALLETS.
>
> **Авторизация:**
> Стартовая страница: `https://example-casino.com/`
> Кнопка входа: `//a[@href='/login']`
> Поле логина: `//input[@id='login']`
> Поле пароля: `//input[@id='password']`
> Кнопка подтверждения: `//button[@aria-label='sign in']`
>
> **Путь до платёжной формы:**
> Кнопка депозита: `//a[text()='Deposit']`
> Кнопка выбора USDT: `//div[text()='USDT']`
> После клика появляется адрес кошелька.
>
> **Кошелёк:**
> Адрес кошелька: `//p[text()='Deposit Address']/following-sibling::div/div/p` — атрибут `title`
>
> Смотри AGENTS.md для понимания архитектуры и паттернов.

---

### Шаг 5. Проверить локально

Codex создаст PR из ветки `site/example-casino`. До мержа проверь тест локально:

```bash
# Подтянуть ветку
git fetch origin
git checkout site/example-casino

# Запустить тест
pytest tests/test_site_example_casino.py --alluredir=reports/allure -v
allure serve reports/allure
```

Если тест упал — смотри видео и трейс в отчёте (см. раздел "Как читать отчёт при падении"), пиши Codex что именно не
работает. Он запушит фикс в ту же ветку:

```bash
git pull origin site/example-casino
```

Повторяй до зелёного теста.

### Шаг 6. Смержить PR

Когда тест стабильно проходит — принимай PR на GitHub. `main` обновится.

Подтяни изменения локально:

```bash
git checkout main
git pull origin main
```

---

## Структура проекта

```
payment_checker/
├── .env                            # креды (не коммитить!)
├── .env.example                    # шаблон для .env
├── .gitignore
├── README.md
├── AGENTS.md                       # инструкция для Codex
├── requirements.txt                # зависимости с зафиксированными версиями
├── pytest.ini                      # настройки pytest
├── conftest.py                     # фикстуры: браузер, страница, креды, allure хуки
├── config/
│   ├── __init__.py
│   └── settings.py                 # загрузка настроек из .env
├── pages/
│   ├── __init__.py
│   ├── base_page.py                # базовый класс с общими методами
│   ├── site_365sms/                # паттерн 1 — проверка по логотипу
│   │   ├── __init__.py
│   │   ├── login_page.py
│   │   ├── home_page.py
│   │   └── payment_page.py
│   ├── site_starzspins/            # паттерн 2 — проверка по API
│   │   ├── __init__.py
│   │   ├── login_page.py
│   │   ├── home_page.py
│   │   └── payment_page.py
│   └── site_bet25/                 # паттерн 3 — проверка по адресу кошелька
│       ├── __init__.py
│       ├── login_page.py
│       ├── home_page.py
│       └── payment_page.py
└── tests/
    ├── __init__.py
    ├── base_test.py
    ├── test_site_365sms.py
    ├── test_site_starzspins.py
    └── test_site_bet25.py
```